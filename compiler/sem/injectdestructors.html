<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- CSS -->
<title>compiler/sem/injectdestructors</title>
<link rel="stylesheet" type="text/css" href="../nimdoc.out.css">

<script type="text/javascript" src="../dochack.js"></script>

<script type="text/javascript">
function main() {
  var pragmaDots = document.getElementsByClassName("pragmadots");
  for (var i = 0; i < pragmaDots.length; i++) {
    pragmaDots[i].onclick = function(event) {
      // Hide tease
      event.target.parentNode.style.display = "none";
      // Show actual
      event.target.parentNode.nextElementSibling.style.display = "inline";
    }
  }

  function switchTheme(e) {
      if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
      } else {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
      }
  }

  const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
  if (toggleSwitch !== null) {
    toggleSwitch.addEventListener('change', switchTheme, false);
  }

  var currentTheme = localStorage.getItem('theme');
  if (!currentTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    currentTheme = 'dark';
  }
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);

    if (currentTheme === 'dark' && toggleSwitch !== null) {
      toggleSwitch.checked = true;
    }
  }
}

window.addEventListener('DOMContentLoaded', main);
</script>

</head>
<body>
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">compiler/sem/injectdestructors</h1>
    <div class="row">
  <div class="three columns">
  <div class="theme-switch-wrapper">
    <label class="theme-switch" for="checkbox">
      <input type="checkbox" id="checkbox" />
      <div class="slider round"></div>
    </label>
    &nbsp;&nbsp;&nbsp; <em>Dark Mode</em>
  </div>
  <div id="global-links">
    <ul class="simple-boot">
      <li><a href="manual.html">Manual</a></li>
      <li><a href="style_guide.html">Style guide</a></li>
      <li><a href="contributing.html">Contribution guide</a></li>
      <li><a href="lib.html">Standard library</a></li>
      <li><a href="../theindex.html">Index</a></li>
      <li><a href="compiler/../theindex.html">Compiler docs</a></li>
    </ul>
  </div>
  <div id="searchInputDiv">
    Search: <input type="text" id="searchInput"
      onkeyup="search()" />
  </div>
  
  <ul class="simple simple-toc" id="toc-list">
<li><a class="reference" id="overview_toc" href="#overview">Overview</a></li>
<li><a class="reference" id="ownership-analysis_toc" href="#ownership-analysis">Ownership analysis</a></li>
<li>
  <a class="reference reference-toplevel" href="#6" id="56">Imports</a>
  <ul class="simple simple-toc-section">
    
  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#12" id="62">Procs</a>
  <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">injectDestructorCalls
      <li><a class="reference" href="#injectDestructorCalls%2CModuleGraph%2CIdGenerator%2CMirEnv%2CPSym%2CMirBody"
    title="injectDestructorCalls(g: ModuleGraph; idgen: IdGenerator; env: var MirEnv;
                      owner: PSym; body: var MirBody)">injectDestructorCalls(g: ModuleGraph; idgen: IdGenerator; env: var MirEnv;
                      owner: PSym; body: var MirBody)</a></li>

  </ul>
  <ul class="simple nested-toc-section">shouldInjectDestructorCalls
      <li><a class="reference" href="#shouldInjectDestructorCalls%2CPSym"
    title="shouldInjectDestructorCalls(owner: PSym): bool">shouldInjectDestructorCalls(owner: PSym): bool</a></li>

  </ul>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#18" id="68">Templates</a>
  <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">buildVoidCall
      <li><a class="reference" href="#buildVoidCall.t%2CMirBuilder%2CMirEnv%2CPSym%2Cuntyped"
    title="buildVoidCall(bu: var MirBuilder; env: var MirEnv; p: PSym; body: untyped)">buildVoidCall(bu: var MirBuilder; env: var MirEnv; p: PSym; body: untyped)</a></li>

  </ul>

  </ul>
</li>

</ul>

  </div>
  &nbsp;&nbsp;<a
href="https://github.com/nim-works/nimskull/tree/8b68b0d610b28ea47204ed0ca4fe9d1fcc19dad8/compiler/sem/injectdestructors.nim#L1"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/nimskull/edit/devel/compiler/sem/injectdestructors.nim#L1" class="link-seesrc" target="_blank" >Edit</a>

  <div class="nine columns" id="content">
  <div id="tocRoot"></div>
  
  <p class="module-desc">This module implements the following MIR passes:<ul class="simple"><li>the 'switch' operation lowering (<tt class="docutils literal"><span class="pre">lowerBranchSwitch</span></tt>)</li>
<li>the pass for collapsing sink assignments into copies, moves, and destrutive moves</li>
<li>the pass for injected <tt class="docutils literal"><span class="pre">wasMoved</span></tt> calls for consumed lvalues</li>
<li>the pass for injecting destructors</li>
</ul>

<h1><a class="toc-backref" id="overview" href="#overview">Overview</a></h1><p>An analysis pass is performed that collects all entities that require destruction into an <tt class="docutils literal"><span class="pre">EntityDict</span></tt>. These are: locals, temporaries, <tt class="docutils literal"><span class="pre">sink</span></tt> parameters, and globals (with some exceptions). If a location has no type-bound <tt class="docutils literal"><span class="pre">=destroy</span></tt> hook (both user-provided and lifted), it is not included.</p>
<p><tt class="docutils literal"><span class="pre">collapseSink</span></tt> then computes for all lvalue expression appearing as source operands to sink assignments whether it's the last use of the value currently stored in the location identified by the lvalue. All sinks where this is the case are remembered, and their corresponding data-flow operation is turned from a 'use' into a 'consume'.</p>
<p>With all sink assignments either collapsed into copy or move assignments, the next analysis step computes which locations need to be destroyed via a destructor call (see <tt class="docutils literal"><span class="pre">computeDestructors</span></tt>).</p>
<p>As the last step, the assignment rewriting and destructor injection is performed, using the previously gathered data.</p>

<h1><a class="toc-backref" id="ownership-analysis" href="#ownership-analysis">Ownership analysis</a></h1><p>Reassigning or reading from a location through a handle that is not the owning one is <strong>not</strong> detected by the analysis. In the following case (assuming no cursor inference):</p>
<pre class="listing"><span class="Keyword">var</span> <span class="Identifier">a</span> <span class="Operator">=</span> <span class="Operator">@</span><span class="Punctuation">[</span><span class="DecNumber">1</span><span class="Punctuation">,</span> <span class="DecNumber">2</span><span class="Punctuation">]</span>
<span class="Keyword">let</span> <span class="Identifier">p</span> <span class="Operator">=</span> <span class="Keyword">addr</span> <span class="Identifier">a</span>

<span class="Keyword">var</span> <span class="Identifier">b</span> <span class="Operator">=</span> <span class="Identifier">a</span>
<span class="Identifier">b</span><span class="Operator">.</span><span class="Identifier">add</span> <span class="DecNumber">3</span>
<span class="Identifier">doAssert</span> <span class="Identifier">p</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Punctuation">[</span><span class="DecNumber">0</span><span class="Punctuation">]</span> <span class="Operator">==</span> <span class="DecNumber">1</span>

<span class="Identifier">a</span> <span class="Operator">=</span> <span class="Operator">...</span> <span class="Comment"># force the earlier move to be destructive</span></pre><p>the analysis will detect <tt class="docutils literal"><span class="pre"><span class="Keyword">var</span> <span class="Identifier">b</span> <span class="Operator">=</span> <span class="Identifier">a</span></span></tt> to be the last usage of <tt class="docutils literal"><span class="pre"><span class="Identifier">a</span></span></tt>, subsequently turning the assignment into a move and thus making the assertion fail with an <tt class="docutils literal"><span class="pre">IndexDefect</span></tt>.</p>
</p>
  <div class="section" id="6">
<h1><a class="toc-backref" href="#6">Imports</a></h1>
<dl class="item">
<a class="reference external" href="../ast/ast.html">../ast/ast</a>, <a class="reference external" href="../ast/lineinfos.html">../ast/lineinfos</a>, <a class="reference external" href="../ast/types.html">../ast/types</a>, <a class="reference external" href="../mir/analysis.html">../mir/analysis</a>, <a class="reference external" href="../mir/mirbodies.html">../mir/mirbodies</a>, <a class="reference external" href="../mir/mirchangesets.html">../mir/mirchangesets</a>, <a class="reference external" href="../mir/mirconstr.html">../mir/mirconstr</a>, <a class="reference external" href="../mir/mirenv.html">../mir/mirenv</a>, <a class="reference external" href="../mir/mirtrees.html">../mir/mirtrees</a>, <a class="reference external" href="../mir/sourcemaps.html">../mir/sourcemaps</a>, <a class="reference external" href="../modules/magicsys.html">../modules/magicsys</a>, <a class="reference external" href="../modules/modulegraphs.html">../modules/modulegraphs</a>, <a class="reference external" href="../front/options.html">../front/options</a>, <a class="reference external" href="aliasanalysis.html">aliasanalysis</a>, <a class="reference external" href="liftdestructors.html">liftdestructors</a>, <a class="reference external" href="mirexec.html">mirexec</a>, <a class="reference external" href="../utils/cursors.html">../utils/cursors</a>, <a class="reference external" href="../utils/idioms.html">../utils/idioms</a>
</dl></div>
<div class="section" id="12">
<h1><a class="toc-backref" href="#12">Procs</a></h1>
<dl class="item">
<div id="injectDestructorCalls,ModuleGraph,IdGenerator,MirEnv,PSym,MirBody">
<dt><pre><span class="Keyword">proc</span> <a href="#injectDestructorCalls%2CModuleGraph%2CIdGenerator%2CMirEnv%2CPSym%2CMirBody"><span class="Identifier">injectDestructorCalls</span></a><span class="Other">(</span><span class="Identifier">g</span><span class="Other">:</span> <a href="../modules/modulegraphs.html#ModuleGraph"><span class="Identifier">ModuleGraph</span></a><span class="Other">;</span> <span class="Identifier">idgen</span><span class="Other">:</span> <a href="../ast/ast_idgen.html#IdGenerator"><span class="Identifier">IdGenerator</span></a><span class="Other">;</span> <span class="Identifier">env</span><span class="Other">:</span> <span class="Keyword">var</span> <a href="../mir/mirenv.html#MirEnv"><span class="Identifier">MirEnv</span></a><span class="Other">;</span>
                           <span class="Identifier">owner</span><span class="Other">:</span> <a href="../ast/ast_types.html#PSym"><span class="Identifier">PSym</span></a><span class="Other">;</span> <span class="Identifier">body</span><span class="Other">:</span> <span class="Keyword">var</span> <a href="../mir/mirbodies.html#MirBody"><span class="Identifier">MirBody</span></a><span class="Other">)</span> {.
    <span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">KeyError</span><span class="Other">,</span> <span class="Identifier">Exception</span><span class="Other">,</span> <span class="Identifier">ERecoverableError</span><span class="Other">,</span> <span class="Identifier">ValueError</span><span class="Other">]</span><span class="Other">,</span>
    <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">ReadDirEffect</span><span class="Other">,</span> <span class="Identifier">RootEffect</span><span class="Other">]</span></span>.}</pre></dt>
<dd>

<p>The <tt class="docutils literal"><span class="pre">injectdestructors</span></tt> pass entry point. The pass is made up of multiple sub-passes, hence the mutable <tt class="docutils literal"><span class="pre"><span class="Identifier">body</span></span></tt> (as opposed to returning a <tt class="docutils literal"><span class="pre">Changeset</span></tt>).</p>
<p>For now, semantic errors and other diagnostics related to lifetime-hook usage are also reported here.</p>

&nbsp;&nbsp;<a
href="https://github.com/nim-works/nimskull/tree/8b68b0d610b28ea47204ed0ca4fe9d1fcc19dad8/compiler/sem/injectdestructors.nim#L873"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/nimskull/edit/devel/compiler/sem/injectdestructors.nim#L873" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>
<div id="shouldInjectDestructorCalls,PSym">
<dt><pre><span class="Keyword">func</span> <a href="#shouldInjectDestructorCalls%2CPSym"><span class="Identifier">shouldInjectDestructorCalls</span></a><span class="Other">(</span><span class="Identifier">owner</span><span class="Other">:</span> <a href="../ast/ast_types.html#PSym"><span class="Identifier">PSym</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">bool</span> {.<span><span class="Other pragmadots">...</span></span><span class="pragmawrap"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span>.}</pre></dt>
<dd>


&nbsp;&nbsp;<a
href="https://github.com/nim-works/nimskull/tree/8b68b0d610b28ea47204ed0ca4fe9d1fcc19dad8/compiler/sem/injectdestructors.nim#L866"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/nimskull/edit/devel/compiler/sem/injectdestructors.nim#L866" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>

</dl></div>
<div class="section" id="18">
<h1><a class="toc-backref" href="#18">Templates</a></h1>
<dl class="item">
<div id="buildVoidCall.t,MirBuilder,MirEnv,PSym,untyped">
<dt><pre><span class="Keyword">template</span> <a href="#buildVoidCall.t%2CMirBuilder%2CMirEnv%2CPSym%2Cuntyped"><span class="Identifier">buildVoidCall</span></a><span class="Other">(</span><span class="Identifier">bu</span><span class="Other">:</span> <span class="Keyword">var</span> <a href="../mir/mirconstr.html#MirBuilder"><span class="Identifier">MirBuilder</span></a><span class="Other">;</span> <span class="Identifier">env</span><span class="Other">:</span> <span class="Keyword">var</span> <a href="../mir/mirenv.html#MirEnv"><span class="Identifier">MirEnv</span></a><span class="Other">;</span> <span class="Identifier">p</span><span class="Other">:</span> <a href="../ast/ast_types.html#PSym"><span class="Identifier">PSym</span></a><span class="Other">;</span>
                       <span class="Identifier">body</span><span class="Other">:</span> <span class="Identifier">untyped</span><span class="Other">)</span></pre></dt>
<dd>


&nbsp;&nbsp;<a
href="https://github.com/nim-works/nimskull/tree/8b68b0d610b28ea47204ed0ca4fe9d1fcc19dad8/compiler/sem/injectdestructors.nim#L526"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/nim-works/nimskull/edit/devel/compiler/sem/injectdestructors.nim#L526" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>

</dl></div>

  </div>
</div>

    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br/>
        <small style="color: var(--hint);">Made with Nim. Generated: 2024-02-28 00:00:00 UTC</small>
      </div>
    </div>
  </div>
</div>
</body>
</html>
